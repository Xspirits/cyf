// Generated by CoffeeScript 1.7.1
(function() {
  var RiotApi, auth, https, request, riotApi, _;

  https = require("https");

  request = require("request");

  auth = require("./auth");

  RiotApi = require('irelia');

  _ = require("underscore");

  riotApi = new RiotApi({
    host: 'prod.api.pvp.net',
    path: '/api/lol/',
    key: auth.leagueoflegend.key,
    debug: true
  });

  exports.findSummonerLol = function(region, name, callback) {
    console.log(region);
    console.log(name);
    return riotApi.getSummonerByName(region, name, function(err, summoner) {
      if (err) {
        throw err;
      }
      summoner = _.values(summoner)[0];
      return callback(summoner);
    });
  };

  exports.getFbData = function(accessToken, apiPath, callback) {
    var buffer, options;
    options = {
      host: "graph.facebook.com",
      path: apiPath + "?access_token=" + accessToken,
      method: "GET"
    };
    buffer = "";
    request = https.get(options, function(result) {
      result.setEncoding("utf8");
      result.on("data", function(chunk) {
        buffer += chunk;
      });
      return result.on("end", function() {
        return callback(buffer);
      });
    });
    request.on("error", function(e) {
      return console.log("error from facebook.getFbData: " + e.message);
    });
    return request.end();
  };

  exports.postTwitter = function(accessToken, message, callback) {
    var form, params, r, url;
    url = "https://api.twitter.com/1.1/statuses/update.json";
    if (!accessToken) {
      params = {
        consumer_key: auth.twitterAuth.consumerKey,
        consumer_secret: auth.twitterAuth.consumerSecret,
        token: auth.twitterCyf.token,
        token_secret: auth.twitterCyf.tokenSecret
      };
    } else {
      params = {
        consumer_key: auth.twitterAuth.consumerKey,
        consumer_secret: auth.twitterAuth.consumerSecret,
        token: accessToken.token,
        token_secret: accessToken.tokenSecret
      };
    }
    r = request.post({
      url: url,
      oauth: params
    }, function(err, resp, body) {
      if (err) {
        return console.error("Error occured: ", err);
      }
      body = JSON.parse(body);
      if (body.error) {
        return console.error("Error returned from  twitter: ", body.error);
      }
      return callback(body);
    });
    form = r.form();
    return form.append("status", message);
  };

  exports.postFbMessage = function(userFB, message, link, callback) {
    var params, url;
    url = "https://graph.facebook.com/me/feed";
    if (message) {
      params = {
        access_token: userFB.token,
        message: message
      };
    } else {
      params = {
        access_token: userFB.token,
        link: link.url || auth.cyf.app_domain,
        picture: link.picture || false,
        name: link.name || false,
        caption: link.caption || false,
        description: link.description || false
      };
    }
    return request.post({
      url: url,
      qs: params
    }, function(err, resp, body) {
      if (err) {
        return console.error("Error occured: ", err);
      }
      body = JSON.parse(body);
      if (body.error) {
        return console.error("Error returned from facebook: ", body.error);
      }
      return callback(JSON.stringify(body, null, "\t"));
    });
  };

  exports.updateWall = function(message, link, callback) {
    var params, url;
    url = "https://graph.facebook.com/" + auth.facebookPage.id + "/feed";
    if (message) {
      params = {
        access_token: auth.facebookPage.accessToken,
        message: message
      };
    } else {
      params = {
        access_token: auth.facebookPage.accessToken,
        link: link.url || auth.cyf.app_domain,
        picture: link.picture || false,
        name: link.name || false,
        caption: link.caption || false,
        description: link.description || false
      };
    }
    return request.post({
      url: url,
      qs: params
    }, function(err, resp, body) {
      if (err) {
        return console.error("Error occured: ", err);
      }
      body = JSON.parse(body);
      if (body.errors) {
        return console.error("Error returned from facebook: ", body.errors);
      }
      return callback(JSON.stringify(body, null, "\t"));
    });
  };

  exports.userActionWallPost = function(user, object, callback) {
    var params, url;
    url = "https://graph.facebook.com/me/feed";
    params = {
      access_token: user.facebook.token,
      name: object.name || false,
      message: object.message || false,
      application: auth.facebookAuth.clientID,
      description: object.description || false,
      actions: JSON.stringify([
        {
          "name": "Challenge Your Friend",
          "link": auth.cyf.app_domain
        }
      ]),
      status_type: 'published_story',
      type: "status"
    };
    return request.post({
      url: url,
      qs: params
    }, function(err, resp, body) {
      if (err) {
        return console.error("Error occured: ", err);
      }
      body = JSON.parse(body);
      if (body.error) {
        return console.error("Error returned from facebook: ", body.error);
      }
      return callback(JSON.stringify(body, null, "\t"));
    });
  };

  exports.userAction = function(user, action, callback) {
    var obj, params, url;
    url = "https://graph.facebook.com/me/cyfbeta:" + action.name;
    console.log('FB Actions for ' + user.local.pseudo);
    params = {
      access_token: user.facebook.token,
      app_id: auth.facebookAuth.clientID,
      notify: true,
      'fb:explicitly_shared': true,
      message: action.message || false,
      image: action.image || auth.cyf.app_domain + '/img/favicon-128.png',
      ref: action.link || auth.cyf.app_domain
    };
    if (action.name === 'rank') {
      obj = {
        ladder: {
          title: action.rankText || 'in the Cyf leaderboard'
        }
      };
    }
    if (action.name === 'reach') {
      obj = {
        level: {
          title: action.levelText || 'a new level'
        }
      };
    }
    _.extend(params, obj);
    return request.post({
      url: url,
      qs: params
    }, function(err, resp, body) {
      if (err) {
        return console.error("Error occured: ", err);
      }
      body = JSON.parse(body);
      if (body.error) {
        return console.error("Error returned from facebook: ", body.error);
      }
      return callback(JSON.stringify(body, null, "\t"));
    });
  };

}).call(this);
